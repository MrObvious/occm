---
sidebar: sidebar
permalink: reference_networking_aws.html
keywords: networking, network, requirements, connection, connections, vpc, security group, security groups, subnets, vpn, internet, nat, s3, dns, ad, active directory, az, availability zone, floating IP, floating, SVM, management LIF, route, route tables, proxy, HTTP, private, tier, s3 endpoint, tiering, storage tier, storage tiering, proxy server, nat device, vpn, snapmanager, snapcenter, iscsi, nfs, cifs, nas, san, outbound, inbound, connections, autosupport, ha, ha pair, high availability
summary: Set up your AWS networking so Cloud Volumes ONTAP systems can operate properly.
---

= Networking requirements for Cloud Volumes ONTAP in AWS
:hardbreaks:
:nofooter:
:icons: font
:linkattrs:
:imagesdir: ./media/

[.lead]
Set up your AWS networking so Cloud Volumes ONTAP systems can operate properly.

== General AWS networking requirements

The following requirements must be met in AWS.

Outbound internet access for Cloud Volumes ONTAP nodes::
Cloud Volumes ONTAP nodes require outbound internet access to send messages to NetApp AutoSupport, which proactively monitors the health of your storage.
+
Routing and firewall policies must allow AWS HTTP/HTTPS traffic to the following endpoints so Cloud Volumes ONTAP can send AutoSupport messages:
+
* \https://support.netapp.com/aods/asupmessage
* \https://support.netapp.com/asupprod/post/1.0/postAsup
+
If you have a NAT instance, you must define an inbound security group rule that allows HTTPS traffic from the private subnet to the internet.
+
link:task_setting_up_ontap_cloud.html[Learn how to configure AutoSupport].

Outbound internet access for the HA mediator::
The HA mediator instance must have an outbound connection to the AWS EC2 service so it can assist with storage failover. To provide the connection, you can add a public IP address, specify a proxy server, or use a manual option.
+
The manual option can be a NAT gateway or an interface VPC endpoint from the target subnet to the AWS EC2 service. For details about VPC endpoints, refer to http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/vpce-interface.html[AWS Documentation: Interface VPC Endpoints (AWS PrivateLink)^].

Number of IP addresses::
Cloud Manager allocates the following number of IP addresses to Cloud Volumes ONTAP in AWS:

* Single node: 6 IP addresses
* HA pairs in single AZs: 15 addresses
* HA pairs in multiple AZs: 15 or 16 IP addresses
+
Note that Cloud Manager creates an SVM management LIF on single node systems, but not on HA pairs in a single AZ. You can choose whether to create an SVM management LIF on HA pairs in multiple AZs.
+
TIP: A LIF is an IP address associated with a physical port. An SVM management LIF is required for management tools like SnapCenter.

Security groups::
You do not need to create security groups because Cloud Manager does that for you. If you need to use your own, refer to link:reference_security_groups.html[Security group rules].

Connection from Cloud Volumes ONTAP to AWS S3 for data tiering::
If you want to use EBS as a performance tier and AWS S3 as a capacity tier, you must ensure that Cloud Volumes ONTAP has a connection to S3. The best way to provide that connection is by creating a VPC Endpoint to the S3 service. For instructions, see https://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/vpce-gateway.html#create-gateway-endpoint[AWS Documentation: Creating a Gateway Endpoint^].
+
When you create the VPC Endpoint, be sure to select the region, VPC, and route table that corresponds to the Cloud Volumes ONTAP instance. You must also modify the security group to add an outbound HTTPS rule that enables traffic to the S3 endpoint. Otherwise, Cloud Volumes ONTAP cannot connect to the S3 service.
+
If you experience any issues, see https://aws.amazon.com/premiumsupport/knowledge-center/connect-s3-vpc-endpoint/[AWS Support Knowledge Center: Why can’t I connect to an S3 bucket using a gateway VPC endpoint?^]

Connections to ONTAP systems in other networks::
To replicate data between a Cloud Volumes ONTAP system in AWS and ONTAP systems in other networks, you must have a VPN connection between the AWS VPC and the other network—for example, an Azure VNet or your corporate network. For instructions, see https://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/SetUpVPNConnections.html[AWS Documentation: Setting Up an AWS VPN Connection^].

DNS and Active Directory for CIFS::
If you want to provision CIFS storage, you must set up DNS and Active Directory in AWS or extend your on-premises setup to AWS.
+
The DNS server must provide name resolution services for the Active Directory environment. You can configure DHCP option sets to use the default EC2 DNS server, which must not be the DNS server used by the Active Directory environment.
+
For instructions, refer to https://docs.aws.amazon.com/quickstart/latest/active-directory-ds/welcome.html[AWS Documentation: Active Directory Domain Services on the AWS Cloud: Quick Start Reference Deployment^].

== AWS networking requirements for HA pairs in multiple AZs

Additional AWS networking requirements apply to Cloud Volumes ONTAP HA configurations that use multiple Availability Zones (AZs). You should review these requirements before you launch an HA pair because you must enter the networking details in Cloud Manager.

To understand how HA pairs work, see link:concept_ha.html[High-availability pairs].

Availability Zones::
This HA deployment model uses multiple AZs to ensure high availability of your data. You should use a dedicated AZ for each Cloud Volumes ONTAP instance and the mediator instance, which provides a communication channel between the HA pair.

Floating IP addresses for NAS data and cluster/SVM management::
HA configurations in multiple AZs use floating IP addresses that migrate between nodes if failures occur. They are not natively accessible from outside the VPC, unless you link:task_setting_up_transit_gateway.html[set up an AWS transit gateway].
+
One floating IP address is for cluster management, one is for NFS/CIFS data on node 1, and one is for NFS/CIFS data on node 2. A fourth floating IP address for SVM management is optional.
+
NOTE: A floating IP address is required for the SVM management LIF if you use SnapDrive for Windows or SnapCenter with the HA pair. If you don't specify the IP address when you deploy the system, you can create the LIF later. For details, see link:task_setting_up_ontap_cloud.html[Setting up Cloud Volumes ONTAP].
+
You need to enter the floating IP addresses in Cloud Manager when you create a Cloud Volumes ONTAP HA working environment. Cloud Manager allocates the IP addresses to the HA pair when it launches the system.
+
The floating IP addresses must be outside of the CIDR blocks for all VPCs in the AWS region in which you deploy the HA configuration. Think of the floating IP addresses as a logical subnet that's outside of the VPCs in your region.
+
The following example shows the relationship between floating IP addresses and the VPCs in an AWS region. While the floating IP addresses are outside the CIDR blocks for all VPCs, they're routable to subnets through route tables.
+
image:diagram_ha_floating_ips.png[A conceptual image showing the CIDR blocks for five VPCs in an AWS region and three floating IP addresses that are outside the CIDR blocks of the VPCs.]
+
NOTE: Cloud Manager automatically creates static IP addresses for iSCSI access and for NAS access from clients outside the VPC. You don't need to meet any requirements for these types of IP addresses.

Transit gateway to enable floating IP access from outside the VPC::
link:task_setting_up_transit_gateway.html[Set up an AWS transit gateway] to enable access to an HA pair's floating IP addresses from outside the VPC where the HA pair resides.

Route tables::
After you specify the floating IP addresses in Cloud Manager, you need to select the route tables that should include routes to the floating IP addresses. This enables client access to the HA pair.
+
If you have just one route table for the subnets in your VPC (the main route table), then Cloud Manager automatically adds the floating IP addresses to that route table. If you have more than one route table, it's very important to select the correct route tables when launching the HA pair. Otherwise, some clients might not have access to Cloud Volumes ONTAP.
+
For example, you might have two subnets that are associated with different route tables. If you select route table A, but not route table B, then clients in the subnet associated with route table A can access the HA pair, but clients in the subnet associated with route table B can't.
+
For more information about route tables, refer to http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/VPC_Route_Tables.html[AWS Documentation: Route Tables^].

Connection to NetApp management tools::
To use NetApp management tools with HA configurations that are in multiple AZs, you have two connection options:

. Deploy the NetApp management tools in a different VPC and link:task_setting_up_transit_gateway.html[set up an AWS transit gateway]. The gateway enables access to the floating IP address for the cluster management interface from outside the VPC.

. Deploy the NetApp management tools in the same VPC with a similar routing configuration as NAS clients.

== Example HA configuration

The following image shows an optimal HA configuration in AWS operating as an active-passive configuration:

image:diagram_ha_networking.png["Conceptual image showing components in a Cloud Volumes ONTAP HA architecture: two Cloud Volumes ONTAP nodes and a mediator instance, each in separate availability zones."]

== Setting up an AWS transit gateway

Set up an AWS transit gateway to enable access to an HA pair's link:reference_networking_aws.html#aws-networking-requirements-for-cloud-volumes-ontap-ha-in-multiple-azs[floating IP addresses] from outside the VPC where the HA pair resides.

When a Cloud Volumes ONTAP HA configuration is spread across multiple AWS Availability Zones, floating IP addresses are required for NAS data access from within the VPC. These floating IP addresses can migrate between nodes when failures occur, but they are not natively accessible from outside the VPC. Separate private IP addresses provide data access from outside the VPC, but they don't provide automatic failover.

Floating IP addresses are also required for the cluster management interface and the optional SVM management LIF.

If you set up an AWS transit gateway, you enable access to the floating IP addresses from outside the VPC where the HA pair resides. That means NAS clients and NetApp management tools outside the VPC can access the floating IPs.

Here's an example that shows two VPCs connected by a transit gateway. An HA system resides in one VPC, while a client resides in the other. You could then mount a NAS volume on the client using the floating IP address.

image:diagram_transit_gateway.png["A diagram that shows an HA configuration in one VPC, with floating IPs routed to ENIs, a client in another VPC, with floating IPs routed to the transit gateway, and a transit gateway, with floating IPs routed to the VPC1 route table."]

The following steps illustrate how to set up a similar configuration.

.Steps

. https://docs.aws.amazon.com/vpc/latest/tgw/tgw-getting-started.html[Create a transit gateway and attach the VPCs to the gateway^].

. Create routes in the transit gateway's route table by specifying the HA pair's floating IP addresses.
+
You can find the floating IP addresses on the Working Environment Information page in Cloud Manager. Here's an example:
+
image:screenshot_floating_ips.gif["A screenshot of Cloud Manager that shows the floating IP addresses for the cluster management interface, two NFS and CIFS data interfaces, and the SVM management interface."]
+
The following sample image shows the route table for the transit gateway. It includes routes to the CIDR blocks of the two VPCs and four floating IP addresses used by Cloud Volumes ONTAP.
+
image:screenshot_transit_gateway1.png[A screenshot of the AWS console that shows the route table for the transit gateway. It includes routes to the CIDR blocks of the two VPCs and four floating IP addresses used by Cloud Volumes ONTAP.]

. Modify the route table of VPCs that need to access the floating IP addresses.
.. Add route entries to the floating IP addresses.
.. Add a route entry to the CIDR block of the VPC where the HA pair resides.
+
The following sample image shows the route table for VPC 2, which includes routes to VPC 1 and the floating IP addresses.
+
image:screenshot_transit_gateway2.png["A screenshot of the AWS console that shows the route table for VPC 2, which includes routes to VPC 1 and the floating IP addresses."]

. Modify the route table for the HA pair's VPC by adding a route to the VPC that needs access to the floating IP addresses.
+
This step is important because it completes the routing between the VPCs.
+
The following sample image shows the route table for VPC 1. It includes a route to the floating IP addresses and to VPC 2, which is where a client resides. Cloud Manager automatically added the floating IPs to the route table when it deployed the HA pair.
+
image:screenshot_transit_gateway3.png["A screenshot of the AWS console that shows the route table for VPC 1. It includes a route to the floating IP addresses and to VPC 2, which is where a client resides."]

. Mount volumes to clients using the floating IP address.
+
You can find the correct IP address in Cloud Manager by selecting a volume and clicking *Mount Command*.
+
image:screenshot_mount.gif[Screen shot: Shows the Mount Command which is available when you select a volume.]

*Related links*

* link:concept_ha.html[High-availability pairs in AWS]
* link:reference_networking_aws.html[Networking requirements for Cloud Volumes ONTAP in AWS]
